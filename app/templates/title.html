{% extends "base.html" %}

{% block title %}トップページ - 武田塾板宿校成績管理システム{% endblock %}

{% block top_nav %}
{% endblock %}

{% block page_sidebar %}
    <button class="hamburger-menu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </button>
    <div id="sidebar-menu" class="sidebar">
        <h3>メニュー</h3>
        <hr>
        <h3>新しい生徒の登録</h3>
        <form action="/" method="POST">
            <input type="hidden" name="form_type" value="student">
            
            <label for="student_name">生徒名:</label>
            <input type="text" id="student_name" name="student_name" required>

            <label for="grade">学年:</label>
            <select id="grade" name="grade" required>
                <option value="">-- 選択してください --</option>
                <option value="中学生">中学生</option>
                <option value="高1">高1</option>
                <option value="高2">高2</option>
                <option value="高3">高3</option>
                <option value="既卒">既卒</option>
            </select>
            
            <button type="submit">登録</button>
        </form>
        <hr>
        <h3>新しいテストの登録</h3>
        <form action="/" method="POST">
            <input type="hidden" name="form_type" value="test">
            <label for="test_name">テスト名:</label>
            <input type="text" id="test_name" name="test_name" required>
            <button type="submit">登録</button>
        </form>
    </div>
    <script>
        const hamburger = document.querySelector('.hamburger-menu');
        const sidebar = document.getElementById('sidebar-menu');
        const mainContent = document.getElementById('main-content');
        hamburger.addEventListener('click', function(e) { e.stopPropagation(); sidebar.classList.toggle('open'); mainContent.classList.toggle('shifted'); });
        document.addEventListener('click', function(e) {
            if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !hamburger.contains(e.target)) {
                sidebar.classList.remove('open');
                mainContent.classList.remove('shifted');
            }
        });
    </script>
{% endblock %}

{% block content %}
    <h1>テスト習慣継続システム</h1>

    <p class="site-description">
        ようこそ！このシステムは、日々のテスト結果を記録し、生徒一人ひとりの成長を可視化するためのツールです。<br>
        成績の入力、グラフでの成績推移の確認、ランキングの表示、AIによる学習コメントの生成など、多彩な機能で学習をサポートします。<br>
        まずはサイドメニューから生徒とテストを登録し、始めてみましょう。
    </p>
    <hr>
    <div>
        <div style="display: inline-block; vertical-align: top; margin-right: 50px;">
            <h2>生徒一覧</h2>
            <button id="open-student-modal-btn">一覧を見る</button>
        </div>
        <div style="display: inline-block; vertical-align: top;">
            <h2>テスト一覧</h2>
            <ul>
                {% for test in tests %}
                    <li>
                        <a href="#" class="test-manage-link" data-testid="{{ test.id }}" data-testname="{{ test.name }}">{{ test.name }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <hr>
    <a href="/ranking/average">全体ランキングを見る</a>
    <br><br>
    <a href="/ranking">週間ランキングを見る</a>
    <br><br>
    <a href="/calendar">成績入力へ（日付選択）</a>
{% endblock %}

{% block extra_scripts %}
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>生徒一覧</h2>
            <div class="modal-list-container">
                <ul>
                    {% for student in students %}
                        <li>
                            <a href="{{ url_for('student_detail', student_id=student.id) }}">
                                {{ student.name }} ({{ student.grade }})
                            </a>
                            <form action="{{ url_for('delete_student', id=student.id) }}" method="POST" style="display: inline;">
                                <button type="submit" onclick="return confirm('本当に削除しますか？');">削除</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div id="test-manage-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-test-name"></h2>
            <hr>
            <form id="edit-test-form" method="POST">
                <label for="new_test_name">新しいテスト名:</label>
                <input type="text" id="new_test_name" name="new_test_name" required>
                <button type="submit">更新</button>
            </form>
            <br>
            <form id="delete-test-form" method="POST" onsubmit="return confirm('本当にこのテストと関連するすべての成績を削除しますか？');">
                 <button type="submit" class="button-danger">このテストを削除する</button>
            </form>
        </div>
    </div>

    <script>
        const studentModal = document.getElementById('student-modal');
        const openStudentBtn = document.getElementById('open-student-modal-btn');
        const closeStudentBtn = studentModal.querySelector('.close-btn');
        openStudentBtn.onclick = function() { studentModal.style.display = "block"; }
        closeStudentBtn.onclick = function() { studentModal.style.display = "none"; }
        
        const testModal = document.getElementById('test-manage-modal');
        const testLinks = document.querySelectorAll('.test-manage-link');
        const modalTestName = document.getElementById('modal-test-name');
        const editForm = document.getElementById('edit-test-form');
        const deleteForm = document.getElementById('delete-test-form');
        const editInput = document.getElementById('new_test_name');
        const closeTestBtn = testModal.querySelector('.close-btn');

        testLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const testId = this.dataset.testid;
                const testName = this.dataset.testname;

                modalTestName.textContent = `「${testName}」の管理`;
                editInput.value = testName;
                editForm.action = `/test/${testId}/update`;
                deleteForm.action = `/test/${testId}/delete`;
                
                testModal.style.display = 'block';
            });
        });
        closeTestBtn.onclick = function() { testModal.style.display = 'none'; }
        
        window.onclick = function(event) {
            if (event.target == studentModal) { studentModal.style.display = "none"; }
            if (event.target == testModal) { testModal.style.display = "none"; }
        }
    </script>
{% endblock %}